


-- Creating storage integration WITH AWS S3 

CREATE STORAGE INTEGRATION nw_int
  TYPE = EXTERNAL_STAGE
  STORAGE_PROVIDER = 'S3'
  ENABLED = TRUE
  STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::642379834531:role/nwrole'
  STORAGE_ALLOWED_LOCATIONS = ('s3://nwdbbucket/');
  
DESC INTEGRATION nw_int;

-- Creating An external Stage with Aws S3 

USE SCHEMA NORTHWINDDB.PUBLIC;

CREATE or replace STAGE NW_STAGE 
URL = 's3://nwdbbucket/'
FILE_FORMAT = my_csv_format
STORAGE_INTEGRATION = nw_int;

LIST @NW_STAGE;
SHOW STAGES;


--- Configured event notification in S3 through SQS queue.


--- Creating Data Pipes 


--PIPELINE FOR ORDERS TABLE

CREATE or replace PIPE ORDER_PIPE AUTO_INGEST = TRUE AS 
COPY INTO NORTHWINDDB.PUBLIC.ORDERS
FROM @NORTHWINDDB.PUBLIC.NW_STAGE/ORDERS
FILE_FORMAT = MY_CSV_FORMAT;

------------------------------------------------

--PIPELINE FOR CATEGORIES TABLE

CREATE or replace PIPE CATEGORIES_PIPE AUTO_INGEST = TRUE AS 
COPY INTO NORTHWINDDB.PUBLIC.CATEGORIES
FROM @NORTHWINDDB.PUBLIC.NW_STAGE/CATEGORIES
FILE_FORMAT = MY_CSV_FORMAT;




------------------------------------------------


--PIPELINE FOR CUSTOMERS TABLE

CREATE or replace PIPE CUSTOMERS_PIPE AUTO_INGEST = TRUE AS 
COPY INTO NORTHWINDDB.PUBLIC.CUSTOMERS
FROM @NORTHWINDDB.PUBLIC.NW_STAGE/CUSTOMERS/
FILE_FORMAT = MY_CSV_FORMAT;
 
------------------------------------------------


--PIPELINE FOR EMPLOYEES TABLE

CREATE or replace PIPE EMPLOYEES_PIPE AUTO_INGEST = TRUE AS 
COPY INTO NORTHWINDDB.PUBLIC.EMPLOYEES
FROM @NORTHWINDDB.PUBLIC.NW_STAGE/EMPLOYEES/
FILE_FORMAT = MY_CSV_FORMAT ;


------------------------------------------------

--PIPELINE FOR ORDER_DETAILS TABLE

CREATE or replace PIPE ORDERDETAILS_PIPE AUTO_INGEST =TRUE AS 
COPY INTO NORTHWINDDB.PUBLIC.ORDERDETAILS
FROM @NORTHWINDDB.PUBLIC.NW_STAGE/ORDERDETAILS/
FILE_FORMAT = MY_CSV_FORMAT;


------------------------------------------------


--PIPELINE FOR PRODUCTS TABLE

CREATE or replace PIPE PRODUCTS_PIPE AUTO_INGEST = TRUE AS 
COPY INTO NORTHWINDDB.PUBLIC.PRODUCTS
FROM @NORTHWINDDB.PUBLIC.NW_STAGE/PRODUCTS/
FILE_FORMAT = MY_CSV_FORMAT;


------------------------------------------------


--PIPELINE FOR SHIPPERS TABLE

CREATE or replace PIPE SHIPPERS_PIPE AUTO_INGEST = TRUE AS 
COPY INTO NORTHWINDDB.PUBLIC.SHIPPERS
FROM @NORTHWINDDB.PUBLIC.NW_STAGE/SHIPPERS/
FILE_FORMAT = MY_CSV_FORMAT;

------------------------------------------------

 Show pipes;
alter pipe ORDERDETAILS_pipe refresh ;
select system$pipe_status ('Order_pipe');

SELECT * FROM SHIPPERS ;
SELECT * FROM PRODUCTS ;
SELECT * FROM ORDERDETAILS;
SELECT * FROM EMPLOYEES ;
SELECT * FROM CUSTOMERS ;
SELECT * FROM ORDERS ;
SELECT * FROM CATEGORIES ; 
